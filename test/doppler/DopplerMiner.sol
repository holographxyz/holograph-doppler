// SPDX-License-Identifier: MIT
pragma solidity ^0.8.24;

import "./interfaces/ITokenFactory.sol";
import "./interfaces/IPoolInitializer.sol";
import "./UniswapV4Types.sol";
import "./DopplerDeployer.sol";
import "forge-std/Vm.sol";
import "forge-std/console.sol";

/**
 * @notice Standalone Doppler mining library without external dependencies
 * @dev Extracted and simplified from doppler's AirlockMiner.sol
 */
library DopplerMiner {
    // mask to slice out the bottom 14 bit of the address
    uint160 constant FLAG_MASK = 0x3FFF;

    // Maximum number of iterations to find a salt, avoid infinite loops
    uint256 constant MAX_LOOP = 100_000;

    uint160 constant FLAGS_DOPPLER_HOOK =
        uint160(
            Hooks.BEFORE_INITIALIZE_FLAG |
                Hooks.AFTER_INITIALIZE_FLAG |
                Hooks.BEFORE_ADD_LIQUIDITY_FLAG |
                Hooks.BEFORE_SWAP_FLAG |
                Hooks.AFTER_SWAP_FLAG |
                Hooks.BEFORE_DONATE_FLAG
        );

    // Hard-coded compiled Doppler bytecode (constructor + runtime)
    // NOTE: generated from `foundry` compilation, trimmed 0x prefix.
    bytes constant HARDCODED_DOPPLER_BYTECODE =
        hex"610160806040526004361015610013575f80fd5b5f905f3560e01c9081630cf756c2146109fd575080631bab58f5146109505780635ec5db32146102fe578063c45a0155146102b9578063d3487997146100a85763f78a8a3e14610061575f80fd5b346100a557806003193601126100a5576040517f0000000000000000000000003411306ce66c9469bff1535ba955503c4bde1c6e6001600160a01b03168152602090f35b80fd5b50346100a55760603660031901126100a5576044356004356001600160401b0382116102b5576100de60609236906004016111c4565b90809391810103126102b557604051916100f7836111f1565b602062ffffff610106836111b0565b9283865261015a610129604061011d8685016111b0565b9384878b01520161124a565b604088810182905251630b4c774160e11b815295869485949216916001600160a01b039081169116600485016112da565b03817f0000000000000000000000004752ba5dbc23f44d87826276bf6fd6b1c372ad246001600160a01b03165afa9081156102aa57849161027b575b506001600160a01b0316913383900361026c5751602092849260649284916001600160a01b03909116908061026757506024355b6040516323b872dd60e01b81527f0000000000000000000000003411306ce66c9469bff1535ba955503c4bde1c6e6001600160a01b03166004820152602481019490945260448401525af13d15601f3d1160018451141617161561022b5780f35b60405162461bcd60e51b81526020600482015260146024820152731514905394d1915497d19493d357d1905253115160621b6044820152606490fd5b6101ca565b634b60273560e01b8452600484fd5b61029d915060203d6020116102a3575b6102958183611227565b8101906112bb565b5f610196565b503d61028b565b6040513d86823e3d90fd5b8280fd5b50346100a557806003193601126100a5576040517f0000000000000000000000004752ba5dbc23f44d87826276bf6fd6b1c372ad246001600160a01b03168152602090f35b50346100a55760203660031901126100a55761031861119a565b7f0000000000000000000000003411306ce66c9469bff1535ba955503c4bde1c6e6001600160a01b03163303610941576001600160a01b03168082526020829052604082206001015490919060e81c60ff166109325781815260208181526040808320600101805460ff60e81b1916600160e81b17905551630dfe168160e01b81529081600481865afa908115610927578291610908575b5060405163d21220a760e01b8152602081600481875afa9081156108fd5783916108de575b506040516334324e9f60e21b815291602083600481885afa9283156102aa57849361089e575b50604051633850c7bd60e01b81529360e085600481895afa801561089157819582916107fa575b50868252602082905260408220546001600160a01b03938416931683149081156107e05787835282602052600160408420015460b81c60020b5b82156107d1578060020b8260020b12155b156107b557505093908681528060205261053a61ffff600160408420015460d01c169288835282602052886105076104bb60036040872001548387528660205260026040882001549061137c565b82865285602052868a856104d684600360408c20015461129a565b95808a5289602052600160408b20015460a01c60020b908a5289602052600160408b20015460b81c60020b906119c0565b90988b865285602052600160408720015460a01c60020b8c875286602052600160408820015460b81c60020b9088611e26565b6105448387611300565b5261054f8286611300565b508091819582918380925b828411156105ea575060e09a5050506001600160801b039182169361058091508461129a565b6001600160801b03928316969116919061059a908761129a565b16936105a7833386612056565b6001600160a01b0316926105bc863386612056565b6040519660018060a01b03168752602087015260408601526060850152608084015260a083015260c0820152f35b909192949398958b60406105fe8885611300565b515160020b606460206106118b88611300565b51015160020b91876001600160801b038561062c8e8b611300565b51015116958551968795869463a34123a760e01b86526004860152602485015260448401525af19081156102aa578d9185918291610784575b5060406106728a87611300565b515160020b60a460206106858d8a611300565b51015183516309e3d67b60e31b8152306004820152602481019390935260020b60448301526001600160801b03606483018190526084830152909485919082908a905af19384156107795786938795610713575b50926106f961070b95936106f36106ff94610705976119b3565b9c6119b3565b9d61203d565b9661203d565b95612005565b92919061055a565b935093506040833d8211610771575b8161072f60409383611227565b8101031261076d57826106f961070b95936106f36106ff9461075f60206107586107059a612029565b9601612029565b9850945050939194506106d9565b8580fd5b3d9150610722565b6040513d88823e3d90fd5b90506107a7915060403d81116107ae575b61079f8183611227565b810190612013565b905f610665565b503d610795565b63294b7ef360e11b8452600290810b6004520b60245250604490fd5b8060020b8260020b131561046d565b87835282602052600160408420015460a01c60020b61045c565b95505060e0853d60e011610889575b8161081660e09383611227565b810103126100a55784516001600160a01b03811681036108855761083c6020870161128c565b9561084960408201611328565b5061085660608201611328565b5061086360808201611328565b5060a081015160ff8116036102b55760c001518015150361088557945f610422565b5080fd5b3d9150610809565b50604051903d90823e3d90fd5b9092506020813d6020116108d6575b816108ba60209383611227565b810103126108d2576108cb9061128c565b915f6103fb565b8380fd5b3d91506108ad565b6108f7915060203d6020116102a3576102958183611227565b5f6103d5565b6040513d85823e3d90fd5b610921915060203d6020116102a3576102958183611227565b5f6103b0565b6040513d84823e3d90fd5b637af1101560e11b8152600490fd5b633617fe5360e11b8252600482fd5b50346100a55760203660031901126100a557610120906040906001600160a01b0361097961119a565b168152806020522060018060a01b038154169060018101549060ff600360028301549201549260405194855260018060a01b03811660208601528060a01c60020b60408601528060b81c60020b606086015261ffff8160d01c166080860152818160e01c16151560a086015260e81c16151560c084015260e0830152610100820152f35b90503461101b5760a036600319011261101b57610a1861119a565b60243591906001600160a01b038316830361101b576084356001600160401b03811161101b57610a4c9036906004016111c4565b9092907f0000000000000000000000003411306ce66c9469bff1535ba955503c4bde1c6e6001600160a01b0316330361118b578360a0918101031261101b5760a081016001600160401b0381118282101761117757604052610aad8361124a565b808252610abc6020850161125a565b93846020840152610acf6040820161125a565b9081604085015260608101359361ffff8516850361101b57846060820152608080830135910152670de0b6b3a764000060808201351161115457610b1d600283810b9088900b818112611268565b6040516322afcccb60e01b815262ffffff84166004820152906020826024817f0000000000000000000000004752ba5dbc23f44d87826276bf6fd6b1c372ad246001600160a01b03165afa9182156110bc575f92611118575b508160020b1561110057610b8d828860020b611337565b610b9a828460020b611337565b6001600160a01b0388811690871610156110f7578796865b610bc2608084013560443561137c565b610bce8160443561129a565b936040519a630b4c774160e11b8c5260208c80610bf562ffffff8d168589600485016112da565b03817f0000000000000000000000004752ba5dbc23f44d87826276bf6fd6b1c372ad246001600160a01b03165afa9b8c156110bc575f9c6110d6575b508b60018060a01b031693845f525f60205260ff600160405f20015460e01c166110c7576001600160a01b038c811690821614941561102b575b5050821561101f57610c7f8460020b6115da565b6001600160a01b03909b169a8b3b1561101b575f8c60248293604051948593849263f637731d60e01b845260018060a01b031660048401525af1611006575b506040519061012082016001600160401b03811183821017610ff2579160038f8f938f91948f958f8e90610e4b9e9d9c9b9a98610e379a60405260018060a01b03168852602088019360018060a01b0316845260408801908c60020b8252606089019260020b835261ffff60808a019116815260a089019160018352604060c08b0195808752608060e08d0199013589526101008c01996044358b52815280602052209960018060a01b039060018060a01b039051161660018060a01b03198b5416178a5560018a019560018060a01b039060018060a01b039051161660018060a01b0319875416178655518554935160b81b9161ffff60d01b905160d01b169260ff60e01b9051151560e01b169360ff60e01b199162ffffff60a01b9060a01b1690600160a01b600160e01b03191617169062ffffff60b81b16171717825551151581549060ff60e81b9060e81b169060ff60e81b19161790555160028401555191015561ffff8a1683878a60020b8760020b6119c0565b92909660020b9060020b61ffff8a16611e26565b610e5961ffff851683611300565b52610e6861ffff841682611300565b50865b61ffff8416811115610ebb57505060405160209690956001600160a01b03908116941692508491507fb224da6575b2c2ffd42454faedb236f7dbe5f92a0c96bb99c0273dbe98464c7e9080a48152f35b610ec58183611300565b515160020b9060406020610ed98386611300565b51015160020b60c46001600160801b0383610ef48689611300565b5101511694898c62ffffff868051610f0b816111f1565b6001600160a01b0394851680825293851660208083019182528e851693909201928352895191820194855251909416848901525116606080840191909152825290610f57608082611227565b85519788958694633c8a7d8d60e01b865230600487015260248601526044850152606484015260a060848401525180918160a48501528484015e81810183018e9052601f01601f191681010301818c8b5af1908115610fe75761ffff92610fc392610fca575b50612005565b9050610e6b565b610fe19060403d81116107ae5761079f8183611227565b50610fbd565b6040513d8b823e3d90fd5b634e487b7160e01b8f52604160045260248ffd5b611013919d505f90611227565b5f9b5f610cbe565b5f80fd5b610c7f8760020b6115da565b60405163a167129560e01b8152929c50602091839182916110579162ffffff8e169190600485016112da565b03815f7f0000000000000000000000004752ba5dbc23f44d87826276bf6fd6b1c372ad246001600160a01b03165af19081156110bc575f9161109d575b50995f80610c6b565b6110b6915060203d6020116102a3576102958183611227565b5f611094565b6040513d5f823e3d90fd5b637983c05160e01b5f5260045ffd5b6110f0919c5060203d6020116102a3576102958183611227565b9a5f610c31565b87968697610bb2565b62ffffff84634d72eb2f60e11b5f521660045260245ffd5b9091506020813d60201161114c575b8161113460209383611227565b8101031261101b576111459061128c565b905f610b76565b3d9150611127565b60809063acd0d9e960e01b5f520135600452670de0b6b3a764000060245260445ffd5b634e487b7160e01b5f52604160045260245ffd5b633617fe5360e11b5f5260045ffd5b600435906001600160a01b038216820361101b57565b35906001600160a01b038216820361101b57565b9181601f8401121561101b578235916001600160401b03831161101b576020838186019501011161101b57565b606081019081106001600160401b0382111761117757604052565b608081019081106001600160401b0382111761117757604052565b601f909101601f19168101906001600160401b0382119082101761117757604052565b359062ffffff8216820361101b57565b35908160020b820361101b57565b15611271575050565b63352d1ec160e11b5f5260020b60045260020b60245260445ffd5b51908160020b820361101b57565b919082039182116112a757565b634e487b7160e01b5f52601160045260245ffd5b9081602091031261101b57516001600160a01b038116810361101b5790565b6001600160a01b0391821681529116602082015262ffffff909116604082015260600190565b80518210156113145760209160051b010190565b634e487b7160e01b5f52603260045260245ffd5b519061ffff8216820361101b57565b60020b9060020b9081156113685781810760020b611353575050565b632dddf51960e11b5f5260045260245260445ffd5b634e487b7160e01b5f52601260045260245ffd5b808202905f1983820990828083109203918083039283670de0b6b3a7640000111561101b57146113e6577faccb18165bd6fe31ae1cf318dc5b51eee0e1ba569b88cd74c1773b91fac1066993670de0b6b3a7640000910990828211900360ee1b910360121c170290565b5050670de0b6b3a764000091500490565b90670de0b6b3a76400008202905f19670de0b6b3a764000084099282808510940393808503948584111561101b571461148757670de0b6b3a764000082910981805f03168092046002816003021880820260020302808202600203028082026002030280820260020302808202600203028091026002030293600183805f03040190848311900302920304170290565b5091500490565b90606082901b905f19600160601b84099282808510940393808503948584111561101b5714611487578190600160601b900981805f03168092046002816003021880820260020302808202600203028082026002030280820260020302808202600203028091026002030293600183805f03040190848311900302920304170290565b81810291905f1982820991838084109303928084039384600160601b111561101b571461155157600160601b910990828211900360a01b910360601c1790565b50505060601c90565b91818302915f198185099383808610950394808603958685111561101b57146115d2579082910981805f03168092046002816003021880820260020302808202600203028082026002030280820260020302808202600203028091026002030293600183805f03040190848311900302920304170290565b505091500490565b60020b908160ff1d82810118620d89e881116118f45763ffffffff9192600182167001fffcb933bd6fad37aa2d162d1a59400102600160801b1891600281166118d8575b600481166118bc575b600881166118a0575b60108116611884575b60208116611868575b6040811661184c575b60808116611830575b6101008116611814575b61020081166117f8575b61040081166117dc575b61080081166117c0575b61100081166117a4575b6120008116611788575b614000811661176c575b6180008116611750575b620100008116611734575b620200008116611719575b6204000081166116fe575b62080000166116e5575b5f126116dd575b0160201c90565b5f19046116d6565b6b048a170391f7dc42444e8fa290910260801c906116cf565b6d2216e584f5fa1ea926041bedfe9890920260801c916116c5565b916e5d6af8dedb81196699c329225ee6040260801c916116ba565b916f09aa508b5b7a84e1c677de54f3e99bc90260801c916116af565b916f31be135f97d08fd981231505542fcfa60260801c916116a4565b916f70d869a156d2a1b890bb3df62baf32f70260801c9161169a565b916fa9f746462d870fdf8a65dc1f90e061e50260801c91611690565b916fd097f3bdfd2022b8845ad8f792aa58250260801c91611686565b916fe7159475a2c29b7443b29c7fa6e889d90260801c9161167c565b916ff3392b0822b70005940c7a398e4b70f30260801c91611672565b916ff987a7253ac413176f2b074cf7815e540260801c91611668565b916ffcbe86c7900a88aedcffc83b479aa3a40260801c9161165e565b916ffe5dee046a99a2a811c461f1969c30530260801c91611654565b916fff2ea16466c96a3843ec78b326b528610260801c9161164b565b916fff973b41fa98c081472e6896dfb254c00260801c91611642565b916fffcb9843d60f6159c9db58835c9266440260801c91611639565b916fffe5caca7e10e4e61c3624eaa0941cd00260801c91611630565b916ffff2e50f5f656932ef12357cf3c7fdcc0260801c91611627565b916ffff97272373d413259a46990580e213a0260801c9161161e565b826345c3193d60e11b5f5260045260245ffd5b60020b5f190190627fffff198212627fffff8313176112a757565b600291820b910b0390627fffff198212627fffff8313176112a757565b6001600160401b0381116111775760051b60200190565b604051906119638261120c565b5f6060838281528260208201528260408201520152565b60020b60010190627fffff8213627fffff198312176112a757565b9060020b9060020b0190627fffff198212627fffff8313176112a757565b919082018092116112a757565b91936119f893969591966101405260e052610100525f60c052610140515f14611e1d578460c0525b6101405115611e17578094611922565b92611a0460c0516115da565b60a05260e05161ffff16670de0b6b3a764000081810291801590830490911417156112a757611a3690610100516113f7565b6080525f91600161ffff60e051160161ffff81116112a75761ffff16611a6e611a5e8261193f565b6040516101205261012051611227565b806101205152611a80601f199161193f565b015f5b818110611dfd5750505f945f5b61ffff60e051168110611ac157505050506101005110611ab257610120519190565b6366bf045960e01b5f5260045ffd5b6101405115611dd057611afb83611af262ffffff611ae861ffff60e051168288168761155a565b1660020b87611995565b6101405161216c565b60c05160020b8160020b03611b14575b50600101611a90565b611b1d816115da565b5f9061010051611bb4575b60a051600194936001600160a01b03928316919092161091908215611bad5760c051925b15611ba4575b60405192611b5f8461120c565b60020b835260020b6020830152838060801b0316604082015261ffff82166060820152611b8f8261012051611300565b52611b9d8161012051611300565b5090611b0b565b5060c051611b52565b8092611b4c565b9892919050610140515f14611d7d57611bd260805160a0518b6121e7565b965b8790610140515f14611d375760a051908b6001600160a01b0380841690821611611d2b575b6001600160a01b038116928315611d075760608c901b600160601b600160e01b0316916001600160a01b03828116929190910316611c3882828561155a565b9282156113685709611d1f575b82611c579382061515910401906119b3565b97610140515f14611ca557600194611c94611c9a928d888060a01b0316888060a01b0360a05116038060ff1d9081011890888060801b0316611511565b906119b3565b999091929350611b28565b60a0518b95906001600160a01b0380821690881611611d13575b6001600160a01b038716908115611d0757600197611c9a94611d00926001600160a01b0380821693909103169060601b600160601b600160e01b031661155a565b04906119b3565b62bfc9215f526004601cfd5b5060a05195508b611cbf565b60010180611c45575f80fd5b5060a0518c9250611bf9565b60a051611c5791906001600160a01b038d811691160360ff81901d9081011860016001600160801b038c16611d6c8382611511565b928260601b910915151601906119b3565b60a05189906001600160a01b0380831690821611611dc5575b611dbf91611dba916001600160a01b0391611db191906121ce565b1660805161148e565b61223b565b96611bd4565b505060a05189611d96565b611afb83611df862ffffff611dee61ffff60e051168288168761155a565b1660020b87611922565b611af2565b602090611e08611956565b82826101205101015201611a83565b84611922565b8060c0526119e8565b93909161ffff9592969396611e39611956565b508715611ffd5750915b611e4c836115da565b918715611ff657815b8815611fef57505b6001600160a01b038316926401000276a38411611f1a575050611e9b915073fffd8963efd1fc6a506488495d951d5263988d266401000276a36121e7565b915b8515611efd5781955b8015611ef657611eb6925061210c565b611ecb8160020b918660020b96838812611268565b60405194611ed88661120c565b855260208501526001600160801b0316604084015216606082015290565b5050611eb6565b611f1481611f0f81620d89e7196120d3565b6120f5565b95611ea6565b909173fffd8963efd1fc6a506488495d951d5263988d26841015611fb8579181611f5f611f8a9473fffd8963efd1fc6a506488495d951d5263988d26611dba956121e7565b94816401000276a3918211611fad575b506001600160a01b0391611f8391906121ce565b169061148e565b6001600160801b038181169083161015611fa657505b91611e9d565b9050611fa0565b909150611f83611f6f565b50611fa09250611dba9190506001600160a01b03611f836401000276a373fffd8963efd1fc6a506488495d951d5263988d266121ce565b9050611e5d565b8091611e55565b905091611e43565b5f1981146112a75760010190565b919082604091031261101b576020825192015190565b51906001600160801b038216820361101b57565b6001600160801b0391821690821601919082116112a757565b60405163a9059cbb60e01b81526001600160a01b03909216600483015260248201929092526020915f9160449183905af13d15601f3d1160015f51141617161561209c57565b60405162461bcd60e51b815260206004820152600f60248201526e1514905394d1915497d19052531151608a1b6044820152606490fd5b60020b9060020b90811561136857627fffff1981145f198314166112a7570590565b9060020b9060020b02908160020b9182036112a757565b5f901561214e571561213d5780611f0f8161213561213061213a95620d89e8611922565b61197a565b6120d3565b90565b80611f0f61213a92620d89e86120d3565b5061213a90611f0f8161213561216782620d89e8611995565b611907565b909190156121a1575f8260020b125f1461219457611f0f816121356121308261213a96611922565b611f0f8161213a936120d3565b5f8260020b125f146121ba57611f0f8161213a936120d3565b611f0f816121356121678261213a96611995565b6001600160a01b0391821690821603919082116112a757565b61213a92611dba929091906001600160a01b0380821690831611612235575b61222e61221f6001600160a01b03838116908516611511565b926001600160a01b03926121ce565b169161155a565b90612206565b6001600160801b0381169190820361224f57565b60405162461bcd60e51b81526020600482015260126024820152716c6971756964697479206f766572666c6f7760701b6044820152606490fdfea164736f6c634300081a000a";

    // Hard-coded compiled DERC20 bytecode
    bytes constant HARDCODED_DERC20_BYTECODE =
        hex"6101c0604052346100ab5761002761001561023e565b9897909796919695929594939461070b565b60405161279f90816112d5823960805181611a67015260a05181611b24015260c05181611a31015260e05181611ab601526101005181611adc01526101205181610b8701526101405181610bb001526101605181818161065201528181610c7e01526115820152610180518181816104a501526115a401526101a051816114350152f35b5f80fd5b634e487b7160e01b5f52604160045260245ffd5b601f909101601f19168101906001600160401b038211908210176100e657604052565b6100af565b604051906100fa6040836100c3565b565b81601f820112156100ab578051906001600160401b0382116100e65760405192610130601f8401601f1916602001856100c3565b828452602083830101116100ab57815f9260208093018386015e8301015290565b51906001600160a01b03821682036100ab57565b6001600160401b0381116100e65760051b60200190565b9080601f830112156100ab57815161019381610165565b926101a160405194856100c3565b81845260208085019260051b8201019283116100ab57602001905b8282106101c95750505090565b602080916101d684610151565b8152019101906101bc565b9080601f830112156100ab5781516101f881610165565b9261020660405194856100c3565b81845260208085019260051b8201019283116100ab57602001905b82821061022e5750505090565b8151815260209182019101610221565b613ab490813803806040519361025482866100c3565b8439820191610140818403126100ab5780516001600160401b0381116100ab57836102809183016100fc565b60208201519093906001600160401b0381116100ab57816102a29184016100fc565b936040830151936102b560608501610151565b936102c260808201610151565b9360a08201519360c08301519360e084015160018060401b0381116100ab57836102ed91860161017c565b6101008501519094906001600160401b0381116100ab57846103109183016101e1565b6101208201519094906001600160401b0381116100ab5761033192016100fc565b9199989796959493929190565b156103465750565b630ca514df60e01b5f5260045266470de4df82000060245260445ffd5b90600182811c92168015610391575b602083101461037d57565b634e487b7160e01b5f52602260045260245ffd5b91607f1691610372565b601f81116103a7575050565b60035f5260205f20906020601f840160051c830193106103e1575b601f0160051c01905b8181106103d6575050565b5f81556001016103cb565b90915081906103c2565b601f82116103f857505050565b5f5260205f20906020601f840160051c83019310610430575b601f0160051c01905b818110610425575050565b5f815560010161041a565b9091508190610411565b8160011b915f199060031b1c19161790565b80519091906001600160401b0381116100e6576104758161046e601054610363565b60106103eb565b602092601f82116001146104a857610498929382915f9261049d575b505061043a565b601055565b015190505f80610491565b60105f52601f198216937f1b6847dc741a1b0cd08d278845f9d819d87b734759afb55fe2de5cb82a9ae672915f5b86811061050c57508360019596106104f4575b505050811b01601055565b01515f1960f88460031b161c191690555f80806104e9565b919260206001819286850151815501940192016104d6565b80519091906001600160401b0381116100e65761054d81610546600454610363565b60046103eb565b602092601f82116001146105745761056f929382915f9261049d57505061043a565b600455565b60045f52601f198216937f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b915f5b8681106105d857508360019596106105c0575b505050811b01600455565b01515f1960f88460031b161c191690555f80806105b5565b919260206001819286850151815501940192016105a2565b156105f757565b631dc0052360e11b5f5260045ffd5b634e487b7160e01b5f52601160045260245ffd5b9067016345785d8a000082029180830467016345785d8a0000149015171561063e57565b610606565b634e487b7160e01b5f52603260045260245ffd5b805182101561066b5760209160051b010190565b610643565b6001600160a01b03165f90815260096020526040902090565b9190820180921161063e57565b1561069f575050565b630443fb3960e11b5f5260045260245260445ffd5b156106bd575050565b6323f3f88b60e01b5f5260045260245260445ffd5b156106db575050565b6305767d1760e01b5f5260045260245260445ffd5b5f1981019190821161063e57565b9190820391821161063e57565b61074b9591816107249261073d959a9b99969c97610873565b6107388166470de4df82000081111561033e565b600d55565b42610160526101805261044c565b8251610759825182146105f0565b5f936107756107678561061a565b670de0b6b3a7640000900490565b5f935b8385106107d75750505050506100fa9291816107a661079c6107676107c29561061a565b83818111156106b4565b6107b381838181106106d2565b816101a052816107c8576106fe565b906109d9565b6107d282306109d9565b6106fe565b909192939561086884600192610863868b61085c61082a61081d8461085261082a61081d878f8161080791610657565b519c8d61084b61084361082a61081d8686610657565b516001600160a01b031690565b6001600160a01b03165f90815260116020526040902090565b918254610689565b9055610657565b541115938d610657565b5490610696565b610689565b960193929190610778565b9290604051916108846040846100c3565b60018352603160f81b60208401908152845190946001600160401b0382116100e6576108ba826108b5600354610363565b61039b565b602090601f83116001146109525791806108e0926108e895945f9261049d57505061043a565b600355610524565b6108f181610b0f565b610120526108fe82610bf7565b610140526020815191012060e052519020610100524660a05261091f610cdc565b6080523060c0526001600160a01b0381161561093e576100fa90610ac7565b631e4fbdf760e01b5f90815260045260245ffd5b60035f52601f19831691907fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b925f5b8181106109c157509160019391856108e8979694106109a9575b505050811b01600355610524565b01515f1960f88460031b161c191690555f808061099b565b92936020600181928786015181550195019301610981565b91906001600160a01b0383168015610ab457600c546001600160a01b03811682149081610aa5575b50610a9657610a1a610a1583600254610689565b600255565b6001600160a01b0384165f90815260208181526040808320805486019055518481527fddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef9190a3600254926001600160d01b03808511610a7f57506100fa929350610da5565b630e58ae9360e11b5f52600485905260245260445ffd5b632e13674560e01b5f5260045ffd5b60ff915060a01c16155f610a01565b63ec442f0560e01b5f525f60045260245ffd5b600b80546001600160a01b039283166001600160a01b0319821681179092559091167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3565b908151602081105f14610b2a575090610b2790610d3a565b90565b6001600160401b0381116100e657610b4e81610b47600554610363565b60056103eb565b602092601f8211600114610b7857610b70929382915f9261049d57505061043a565b60055560ff90565b60055f52601f198216937f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db0915f5b868110610bdf5750836001959610610bc7575b505050811b0160055560ff90565b01515f1960f88460031b161c191690555f8080610bb9565b91926020600181928685015181550194019201610ba6565b908151602081105f14610c0f575090610b2790610d3a565b6001600160401b0381116100e657610c3381610c2c600654610363565b60066103eb565b602092601f8211600114610c5d57610c55929382915f9261049d57505061043a565b60065560ff90565b60065f52601f198216937ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f915f5b868110610cc45750836001959610610cac575b505050811b0160065560ff90565b01515f1960f88460031b161c191690555f8080610c9e565b91926020600181928685015181550194019201610c8b565b60e051610100516040519060208201927f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f8452604083015260608201524660808201523060a082015260a08152610d3460c0826100c3565b51902090565b601f815111610d65576020815191015160208210610d56571790565b5f198260200360031b1b161790565b604460209160405192839163305a27a960e01b83528160048401528051918291826024860152018484015e5f828201840152601f01601f19168101030190fd5b90610daf81610ea4565b9165ffffffffffff4311610e8c57600a5480610e565750610de9610dd96100fa945f5b6001611278565b65ffffffffffff4316600a611159565b50506001600160a01b03168015610e3e575b60086020527f5eff886ea0ce6ca488a3d6e336d6c0f75f46d19b42c06ce5ee98e42c96d256c7545f9182526040909120546001600160a01b039081169116610fd3565b610e4f610e4a83610ea4565b610ed5565b5050610dfb565b92835f1981011161063e57600a5f525f80516020613a74833981519152909301546100fa93610de991610dd9919060301c610dd2565b6306dfcc6560e41b5f5260306004524360245260445ffd5b6001600160d01b038111610ebe576001600160d01b031690565b6306dfcc6560e41b5f5260d060045260245260445ffd5b65ffffffffffff4311610e8c57600a5480610eff5750610dd9610efb915f5b6002611278565b9091565b805f1981011161063e57600a5f525f80516020613a748339815191520154610efb91610dd99160301c610ef4565b65ffffffffffff4311610e8c57805480610f615750610f51610efb925f6002611278565b9065ffffffffffff431690611159565b805f1981011161063e575f82815260209020015f190154610efb92610f519160301c610ef4565b65ffffffffffff4311610e8c57805480610fac5750610f51610efb925f6001611278565b805f1981011161063e575f82815260209020015f190154610efb92610f519160301c610dd2565b6001600160a01b038083169392919081169081851415806110a8575b610ffb575b5050505050565b8161105d575b505082611010575b8080610ff4565b5f80516020613a948339815191529161103461102e61103a93610670565b91610ea4565b90610f88565b604080516001600160d01b039384168152919092166020820152a25f8080611009565b6110866110775f80516020613a9483398151915292610670565b61108086610ea4565b90610f2d565b604080516001600160d01b039384168152919092166020820152a25f80611001565b50831515610fef565b9065ffffffffffff82549181199060301b169116179055565b908154680100000000000000008110156100e6576001810180845581101561066b576100fa925f5260205f20019065ffffffffffff81511665ffffffffffff19835416178255602060018060d01b0391015116906110b1565b604080519192919081016001600160401b038111828210176100e657604052915465ffffffffffff8116835260301c6020830152565b80549293929190821561124f57611185611180611175856106f0565b835f5260205f200190565b611123565b9065ffffffffffff61119d835165ffffffffffff1690565b8185169182911611611240576112049460209488926111d06111c5875165ffffffffffff1690565b65ffffffffffff1690565b0361120857506111f6926111e66111f1926106f0565b905f5260205f200190565b6110b1565b01516001600160d01b031690565b9190565b91505061123b9161122861121a6100eb565b65ffffffffffff9093168352565b6001600160d01b038816828601526110ca565b6111f6565b632520601d60e01b5f5260045ffd5b611273925061125f61121a6100eb565b6001600160d01b03851660208301526110ca565b5f9190565b919091806001146112ba5760021461129e57634e487b7160e01b5f52605160045260245ffd5b6001600160d01b039081169181169190910390811161063e5790565b506001600160d01b039182169082160190811161063e579056fe60806040526004361015610011575f80fd5b5f3560e01c806306fdde03146102d4578063095ea7b3146102cf57806310aa0ebb146102ca57806313cff13d146102c55780631514617e146102c057806316f0115b146102bb57806318160ddd146102b657806320720df7146102b1578063207d0636146102ac57806323b872dd146102a7578063254800d4146102a2578063313ce5671461029d5780633644e515146102985780633a46b1a8146102935780633c130d901461028e57806342966c68146102895780634bf5d7e9146102845780634c8697951461027f578063587cde1e1461027a5780635c19a95c146102755780636fcfff451461027057806370a082311461026b578063715018a6146102665780637ecebe001461026157806384b0196e1461025c57806386d1a69f1461025757806389026538146102525780638da5cb5b1461024d5780638e539e8c146102485780638e80ff5d1461024357806391ddadf41461023e57806395d89b411461023957806398cd6153146102345780639ab24eb01461022f5780639ccb51751461022a578063a9059cbb14610225578063c3cda52014610220578063c551a2f91461021b578063d505accf14610216578063dd62ed3e14610211578063f1127ed81461020c578063f2fde38b14610207578063f68d90d8146102025763f6939d34146101fd575f80fd5b6114b0565b61141e565b6113ab565b611314565b6112e8565b6111dd565b6111c5565b6110cd565b611087565b61100a565b610fc3565b610f52565b610e81565b610e56565b610e39565b610d45565b610d1d565b610ce7565b610c6c565b610b6f565b610b37565b610aef565b610acc565b610a6a565b610a48565b610a08565b6109e5565b610955565b610868565b6107d6565b6106b2565b610690565b610675565b61063b565b61056d565b61052a565b61050d565b6104f0565b6104c8565b61048e565b610471565b61044c565b61041b565b610311565b805180835260209291819084018484015e5f828201840152601f01601f1916010190565b90602061030e9281815201906102d9565b90565b346103eb575f3660031901126103eb576040515f60035461033181610747565b80845290600181169081156103c75750600114610369575b61036583610359818503826107b3565b604051918291826102fd565b0390f35b60035f9081527fc2575a0e9e593c00f959f8c92f12db2869c3395a3b0502d05e2516446f71f85b939250905b8082106103ad57509091508101602001610359610349565b919260018160209254838588010152019101909291610395565b60ff191660208086019190915291151560051b840190910191506103599050610349565b5f80fd5b600435906001600160a01b03821682036103eb57565b602435906001600160a01b03821682036103eb57565b346103eb5760403660031901126103eb576104416104376103ef565b6024359033611da8565b602060405160018152f35b346103eb575f3660031901126103eb57602060ff600c5460a01c166040519015158152f35b346103eb575f3660031901126103eb576020600e54604051908152f35b346103eb575f3660031901126103eb5760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b346103eb575f3660031901126103eb57600c546040516001600160a01b039091168152602090f35b346103eb575f3660031901126103eb576020600254604051908152f35b346103eb575f3660031901126103eb576020600d54604051908152f35b346103eb5760203660031901126103eb576105436103ef565b61054b611929565b600c80546001600160a81b0319166001600160a01b0392909216919091179055005b346103eb5760603660031901126103eb576105866103ef565b61058e610405565b6044359061059c33846118ca565b92600184016105bc575b6105b09350611967565b60405160018152602090f35b828410610620576001600160a01b038116801561060d5733156105fa576105b09484915f526001602052036105f43360405f2061148a565b556105a6565b634a1406b160e11b5f525f60045260245ffd5b63e602df0560e01b5f525f60045260245ffd5b8284637dc7a0d960e11b5f523360045260245260445260645ffd5b346103eb575f3660031901126103eb5760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b346103eb575f3660031901126103eb57602060405160128152f35b346103eb575f3660031901126103eb5760206106aa611a2e565b604051908152f35b346103eb5760403660031901126103eb576106cb6103ef565b60243565ffffffffffff6106de43611b4a565b169182821015610731576001600160a01b03165f90815260096020526040902061036592506001600160d01b0391610720919061071a90611b4a565b90611b79565b604051911681529081906020820190565b50637669fc0f60e11b5f5260045260245260445ffd5b90600182811c92168015610775575b602083101461076157565b634e487b7160e01b5f52602260045260245ffd5b91607f1691610756565b634e487b7160e01b5f52604160045260245ffd5b604081019081106001600160401b038211176107ae57604052565b61077f565b601f909101601f19168101906001600160401b038211908210176107ae57604052565b346103eb575f3660031901126103eb576040515f6010546107f681610747565b80845290600181169081156103c7575060011461081d5761036583610359818503826107b3565b60105f9081525f80516020612753833981519152939250905b80821061084e57509091508101602001610359610349565b919260018160209254838588010152019101909291610836565b346103eb5760203660031901126103eb57600435610884611929565b600b546001600160a01b031690811561094257600c546001600160a01b038116159081610933575b50610924576108ba82611458565b5481811061090e5761090c92825f92036108d382611458565b556108e18360025403600255565b81815f805160206127338339815191526040518061090488829190602083019252565b0390a36124c2565b005b63391434e360e21b5f5261092192611950565b5ffd5b632e13674560e01b5f5260045ffd5b60ff915060a01c16155f6108ac565b634b637e8f60e11b5f525f60045260245ffd5b346103eb575f3660031901126103eb5761096e43611b4a565b65ffffffffffff8061097f43611b4a565b169116036109d6576103656040516109986040826107b3565b601d81527f6d6f64653d626c6f636b6e756d6265722666726f6d3d64656661756c7400000060208201526040519182916020835260208301906102d9565b6301bfc1c560e61b5f5260045ffd5b346103eb5760203660031901126103eb5760206106aa610a036103ef565b611580565b346103eb5760203660031901126103eb576001600160a01b03610a296103ef565b165f526008602052602060018060a01b0360405f205416604051908152f35b346103eb5760203660031901126103eb5761090c610a646103ef565b33611c0a565b346103eb5760203660031901126103eb576001600160a01b03610a8b6103ef565b165f52600960205260405f205463ffffffff8111610ab55760405163ffffffff9091168152602090f35b6306dfcc6560e41b5f52602060045260245260445ffd5b346103eb5760203660031901126103eb5760206106aa610aea6103ef565b61165c565b346103eb575f3660031901126103eb57610b07611929565b600b80546001600160a01b031981169091555f906001600160a01b03165f805160206127138339815191528280a3005b346103eb5760203660031901126103eb576001600160a01b03610b586103ef565b165f526007602052602060405f2054604051908152f35b346103eb575f3660031901126103eb57610c13610bab7f00000000000000000000000000000000000000000000000000000000000000006120cc565b610bd47f0000000000000000000000000000000000000000000000000000000000000000612191565b6020604051610be382826107b3565b5f815281610c2181830194601f198301368737604051978897600f60f81b895260e0858a015260e08901906102d9565b9087820360408901526102d9565b914660608701523060808701525f60a087015285830360c087015251918281520192915f5b828110610c5557505050500390f35b835185528695509381019392810192600101610c46565b346103eb575f3660031901126103eb577f000000000000000000000000000000000000000000000000000000000000000015610cd857610cab33611580565b335f526011602052600160405f2001908154818101809111610cd35761090c92553330611967565b6114f4565b63641c0b2160e11b5f5260045ffd5b346103eb575f3660031901126103eb57610cff611929565b600c805460ff60a01b1916600160a01b17905542600f819055600e55005b346103eb575f3660031901126103eb57600b546040516001600160a01b039091168152602090f35b346103eb5760203660031901126103eb5760043565ffffffffffff610d6943611b4a565b169081811015610e2457610d7c90611b4a565b600a54905f829160058411610dd0575b610d989350600a611f80565b80610db4575060205f5b6040516001600160d01b039091168152f35b610dbf602091611534565b600a5f52815f20015460301c610da2565b9192610ddb81611e0d565b8103908111610cd357610d9893600a5f5265ffffffffffff8260205f2001541665ffffffffffff8516105f14610e12575091610d8c565b929150610e1e90611519565b90610d8c565b637669fc0f60e11b5f5260045260245260445ffd5b346103eb575f3660031901126103eb576020600f54604051908152f35b346103eb575f3660031901126103eb576020610e7143611b4a565b65ffffffffffff60405191168152f35b346103eb575f3660031901126103eb576040515f600454610ea181610747565b80845290600181169081156103c75750600114610ec85761036583610359818503826107b3565b60045f9081527f8a35acfbc15ff81a39ae7d344fd709f28e8600b4aa8c65c6b64bfe7fe36bd19b939250905b808210610f0c57509091508101602001610359610349565b919260018160209254838588010152019101909291610ef4565b60405190610f356040836107b3565b565b6001600160401b0381116107ae57601f01601f191660200190565b346103eb5760203660031901126103eb576004356001600160401b0381116103eb57366023820112156103eb578060040135610f8d81610f37565b90610f9b60405192836107b3565b80825236602482850101116103eb576020815f92602461090c96018386013783010152611676565b346103eb5760203660031901126103eb576001600160a01b03610fe46103ef565b165f526009602052602060018060d01b0361100160405f20611c76565b16604051908152f35b346103eb5760203660031901126103eb57600435611026611929565b66470de4df820000811161106a57600e54151580611055575b61104857600d55005b6110506117c8565b600d55005b50600f544281420311610cd35742141561103f565b630ca514df60e01b5f5260045266470de4df82000060245260445ffd5b346103eb5760403660031901126103eb576104416110a36103ef565b6024359033611967565b6064359060ff821682036103eb57565b6084359060ff821682036103eb57565b346103eb5760c03660031901126103eb576110e66103ef565b602435906044356110f56110ad565b6084359060a435928042116111b3579161117a939161116c6111719460405160208101917fe48329057bfd03d55e49b547132e39cffd9c1820ad7b9d4c5307691425d15adf835260018060a01b038a1660408301528a606083015260808201526080815261116460a0826107b3565b519020611ca0565b612236565b909291926122d7565b61118381611d86565b8093036111945761090c9250611c0a565b90506301d4b62360e61b5f5260018060a01b031660045260245260445ffd5b632341d78760e11b5f5260045260245ffd5b346103eb575f3660031901126103eb5761090c6117c8565b346103eb5760e03660031901126103eb576111f66103ef565b6111fe610405565b604435906064359261120e6110bd565b60a43560c435908642116112d55761129a9261129561122c86611d86565b9860405160208101917f6e71edae12b1b97f4d1f60370fef10105fa2faae0126114a169c64845d6126c9835260018060a01b0389169b8c604084015260018060a01b038b1660608401528b608084015260a083015260c082015260c0815261116460e0826107b3565b611cc6565b936001600160a01b038516036112b45761090c9350611da8565b6325c0072360e11b5f526001600160a01b038085166004521660245260445ffd5b8663313c898160e11b5f5260045260245ffd5b346103eb5760403660031901126103eb5760206106aa6113066103ef565b61130e610405565b906118ca565b346103eb5760403660031901126103eb5761132d6103ef565b6024359063ffffffff821682036103eb576113829161137c9161134e611911565b50611357611911565b506001600160a01b03165f908152600960205260409020611376611911565b50612353565b5061237c565b60408051825165ffffffffffff1681526020928301516001600160d01b03169281019290925290f35b346103eb5760203660031901126103eb576113c46103ef565b6113cc611929565b6001600160a01b0316801561140b57600b80546001600160a01b0319811683179091556001600160a01b03165f805160206127138339815191525f80a3005b631e4fbdf760e01b5f525f60045260245ffd5b346103eb575f3660031901126103eb5760206040517f00000000000000000000000000000000000000000000000000000000000000008152f35b6001600160a01b03165f90815260208190526040902090565b6001600160a01b03165f90815260096020526040902090565b9060018060a01b03165f5260205260405f2090565b908152602081019190915260400190565b346103eb5760203660031901126103eb576001600160a01b036114d16103ef565b165f52601160205260405f2060018154910154906103656040519283928361149f565b634e487b7160e01b5f52601160045260245ffd5b906301e133808201809211610cd357565b9060018201809211610cd357565b91908201809211610cd357565b5f19810191908211610cd357565b91908203918211610cd357565b81810292918115918404141715610cd357565b811561156c570490565b634e487b7160e01b5f52601260045260245ffd5b7f0000000000000000000000000000000000000000000000000000000000000000907f0000000000000000000000000000000000000000000000000000000000000000808301808411610cd357421015611635576001600160a01b0382165f9081526011602052604090205442938403938411610cd35761161260019261160d61030e9661162d9461154f565b611562565b6001600160a01b039093165f90815260116020526040902090565b015490611542565b506001600160a01b03165f908152601160205260409020805461030e92509060019061162d565b6001600160a01b03165f9081526020819052604090205490565b9061167f611929565b81516001600160401b0381116107ae576116a38161169e601054610747565b61174c565b602092601f82116001146116e3576116d3929382915f926116d8575b50508160011b915f199060031b1c19161790565b601055565b015190505f806116bf565b60105f52601f198216935f80516020612753833981519152915f5b868110611734575083600195961061171c575b505050811b01601055565b01515f1960f88460031b161c191690555f8080611711565b919260206001819286850151815501940192016116fe565b601f8111611758575050565b60105f5260205f20906020601f840160051c83019310611792575b601f0160051c01905b818110611787575050565b5f815560010161177c565b9091508190611773565b156117a357565b633601f27d60e11b5f5260045ffd5b156117b957565b63bbb80c2b60e01b5f5260045ffd5b600e546117d681151561179c565b5f90600254600f5490600d54915b6117ed84611508565b421115611851576118499161183d611836611825611816611843956118118a611508565b611542565b611820888661154f565b61154f565b6a1a1601fc4ea7109e000000900490565b8092611527565b95611527565b92611508565b9192826117e4565b9091610f35949392824211611892575b505050611878906118738315156117b2565b600e55565b61188142600f55565b600b546001600160a01b0316611cd5565b6118256118c1936118b56118ae6118789798956118bb9561154f565b9142611542565b9061154f565b90611527565b91905f80611861565b906001600160a01b0381166e22d473030f116ddee9f6b43ac78ba31461190a576119069160018060a01b03165f52600160205260405f2061148a565b5490565b50505f1990565b6040519061191e82610793565b5f6020838281520152565b600b546001600160a01b0316330361193d57565b63118cdaa760e01b5f523360045260245ffd5b6001600160a01b0316600452602452604452606490565b6001600160a01b038116939291908415610942576001600160a01b0382168015611a1b57600c546001600160a01b03811682149081611a0c575b50610924576119af82611458565b54958487106119f75784610f359697036119c884611458565b556119d284611458565b8054860190556040518581525f80516020612733833981519152908060208101610904565b63391434e360e21b5f52610921858885611950565b60ff915060a01c16155f6119a1565b63ec442f0560e01b5f525f60045260245ffd5b307f00000000000000000000000000000000000000000000000000000000000000006001600160a01b03161480611b21575b15611a89577f000000000000000000000000000000000000000000000000000000000000000090565b60405160208101907f8b73c3c69bb8fe3d512ecc4cf759cc79239f7b179b0ffacaa9a75d522b39400f82527f000000000000000000000000000000000000000000000000000000000000000060408201527f000000000000000000000000000000000000000000000000000000000000000060608201524660808201523060a082015260a08152611b1b60c0826107b3565b51902090565b507f00000000000000000000000000000000000000000000000000000000000000004614611a60565b65ffffffffffff8111611b625765ffffffffffff1690565b6306dfcc6560e41b5f52603060045260245260445ffd5b908154905f829160058411611bb7575b611b94935084611f80565b80611b9f5750505f90565b611ba890611534565b905f5260205f20015460301c90565b9192611bc281611e0d565b8103908111610cd357611b9493855f5265ffffffffffff8260205f2001541665ffffffffffff8516105f14611bf8575091611b89565b929150611c0490611519565b90611b89565b6001600160a01b038181165f81815260086020526040812080548685166001600160a01b031982168117909255610f3596941694611c709390928691907f3134e8a2e6d97e929a7e54011ea5485d7d196dd5f0ba4d4ef95803e8e3fc257f9080a461165c565b91611fe4565b80549081611c845750505f90565b815f19810111610cd3575f525f199060205f2001015460301c90565b604290611cab611a2e565b906040519161190160f01b8352600283015260228201522090565b9161030e939161117193612236565b91906001600160a01b0383168015611a1b57600c546001600160a01b03811682149081611d77575b5061092457611d16611d1183600254611527565b600255565b611d1f84611458565b8054830190556040518281525f905f8051602061273383398151915290602090a3600254926001600160d01b03808511611d605750610f359293505f6124c2565b630e58ae9360e11b5f52600485905260245260445ffd5b60ff915060a01c16155f611cfd565b6001600160a01b03165f90815260076020526040902080546001810190915590565b6001600160a01b031690811561060d576001600160a01b0381169283156105fa5780611e007f8c5be1e5ebec7d5bd14f71427d1e84f3dd0314c0f7b2291e5b200ac8c7c3b92593855f52600160205260405f2061148a565b55604051908152602090a3565b8015611f7b5761030e90611f11611f0a611f00611ef6611eec611ee2611ed8611ece6001611ebc5f8b608081901c80611f6d575b5080611e50611eb29260401c90565b80611f60575b50611e618160201c90565b80611f53575b50611e728160101c90565b80611f46575b50611e838160081c90565b80611f39575b50611e948160041c90565b80611f2c575b50611ea58160021c90565b80611f1f575b5060011c90565b611f175760011c90565b1b611ec7818b611562565b0160011c90565b611ec7818a611562565b611ec78189611562565b611ec78188611562565b611ec78187611562565b611ec78186611562565b611ec78185611562565b8092611562565b906123a0565b820160011c90565b600291509201915f611eab565b600491509201915f611e9a565b600891509201915f611e89565b601091509201915f611e78565b602091509201915f611e67565b604091509201915f611e56565b608092509050611eb2611e41565b505f90565b91905b838210611f905750505090565b9091928083169080841860011c8201809211610cd357845f5265ffffffffffff8260205f2001541665ffffffffffff8416105f14611fd25750925b9190611f83565b939250611fde90611519565b91611fcb565b6001600160a01b038083169392919081169081851415806120c3575b61200c575b5050505050565b81612073575b505082612021575b8080612005565b5f805160206127738339815191529161204561203f61204b93611471565b916123b2565b9061241b565b604051918291612068916001600160d01b0391821691168361149f565b0390a25f808061201a565b61209c61208d5f8051602061277383398151915292611471565b612096866123b2565b906123e3565b6040519182916120b9916001600160d01b0391821691168361149f565b0390a25f80612012565b50831515612000565b60ff81146120dd5761030e90612484565b50604051600554815f6120ef83610747565b80835292600181169081156121725750600114612113575b61030e925003826107b3565b5060055f90815290917f036b6384b5eca791c62761152d0c79bb0604c104a5fb6f4eb0703f3154bb3db05b81831061215657505090602061030e92820101612107565b602091935080600191548385880101520191019091839261213e565b6020925061030e94915060ff191682840152151560051b820101612107565b60ff81146121a25761030e90612484565b50604051600654815f6121b483610747565b808352926001811690811561217257506001146121d75761030e925003826107b3565b5060065f90815290917ff652222313e28459528d920b65115c16c04f3efc82aaedc97be59f3f377c0d3f5b81831061221a57505090602061030e92820101612107565b6020919350806001915483858801015201910190918392612202565b91906fa2a8918ca85bafe22016d0b997e4df60600160ff1b0384116122ae579160209360809260ff5f9560405194855216868401526040830152606082015282805260015afa156122a3575f516001600160a01b0381161561229957905f905f90565b505f906001905f90565b6040513d5f823e3d90fd5b5050505f9160039190565b600411156122c357565b634e487b7160e01b5f52602160045260245ffd5b6122e0816122b9565b806122e9575050565b6122f2816122b9565b600181036123095763f645eedf60e01b5f5260045ffd5b612312816122b9565b6002810361232d575063fce698f760e01b5f5260045260245ffd5b806123396003926122b9565b146123415750565b6335e2f38360e21b5f5260045260245ffd5b8054821015612368575f5260205f2001905f90565b634e487b7160e01b5f52603260045260245ffd5b9060405161238981610793565b915465ffffffffffff8116835260301c6020830152565b90808210156123ad575090565b905090565b6001600160d01b0381116123cc576001600160d01b031690565b6306dfcc6560e41b5f5260d060045260245260445ffd5b906123ed43611b4a565b906123f783611c76565b6001600160d01b039182169082160391908211610cd357612417926125f3565b9091565b9061242543611b4a565b9061242f83611c76565b6001600160d01b039182169082160191908211610cd357612417926125f3565b61245843611b4a565b90612463600a611c76565b6001600160d01b0391821690821603908111610cd35761241791600a6125f3565b60ff811690601f82116124b357604051916124a06040846107b3565b6020808452838101919036833783525290565b632cd44ac360e21b5f5260045ffd5b9091906001600160a01b03168015612529575b610f35926001600160a01b0316908115612511575b5f90815260086020526040808220549282529020546001600160a01b039081169116611fe4565b61252261251d846123b2565b61244f565b50506124ea565b612532826123b2565b9261253c43611b4a565b93612547600a611c76565b6001600160d01b039182169082160194908511610cd357610f359461256d91600a6125f3565b90505092506124d5565b9065ffffffffffff82549181199060301b169116179055565b8054600160401b8110156107ae576125ad91600182018155612353565b6125e0578165ffffffffffff610f3593511665ffffffffffff19835416178255602060018060d01b039101511690612577565b634e487b7160e01b5f525f60045260245ffd5b8054929392919082156126e95761261f61261a61260f85611534565b835f5260205f200190565b61237c565b9065ffffffffffff612637835165ffffffffffff1690565b81851691829116116126da5761269e94602094889261266a61265f875165ffffffffffff1690565b65ffffffffffff1690565b036126a257506126909261268061268b92611534565b905f5260205f200190565b612577565b01516001600160d01b031690565b9190565b9150506126d5916126c26126b4610f26565b65ffffffffffff9093168352565b6001600160d01b03881682860152612590565b612690565b632520601d60e01b5f5260045ffd5b61270d92506126f96126b4610f26565b6001600160d01b0385166020830152612590565b5f919056fe8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e0ddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef1b6847dc741a1b0cd08d278845f9d819d87b734759afb55fe2de5cb82a9ae672dec2bacdd2f05b59de34da9b523dff8be42e5e38e818c82fdb0bae774387a724a164736f6c634300081a000ac65a7bb8d6351c1cf70c95a316cc6a92839c986682d98bc35f958f4883f9d2a7dec2bacdd2f05b59de34da9b523dff8be42e5e38e818c82fdb0bae774387a724000000000000000000000000000000000000000000000000000000000000014000000000000000000000000000000000000000000000000000000000000001800000000000000000000000000000000000000000033b2e3c9fd0803ce80000000000000000000000000000003411306ce66c9469bff1535ba955503c4bde1c6e0000000000000000000000003411306ce66c9469bff1535ba955503c4bde1c6e00000000000000000000000000000000000000000000000000470de4df8200000000000000000000000000000000000000000000000000000000000001e1338000000000000000000000000000000000000000000000000000000000000001c00000000000000000000000000000000000000000000000000000000000000200000000000000000000000000000000000000000000000000000000000000024000000000000000000000000000000000000000000000000000000000000000025633000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000750464b55474b470000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000010000000000000000000000002900dc215d275d294ad0d882454798be4057e14100000000000000000000000000000000000000000000000000000000000000010000000000000000000000000000000000000000000771d2fa45345aa9000000000000000000000000000000000000000000000000000000000000000000001e68747470733a2f2f7061726167726170682e636f6d2f746f6b656e2f56330000";

    struct MineV4Params {
        address airlock;
        address poolManager;
        uint256 initialSupply;
        uint256 numTokensToSell;
        address numeraire;
        ITokenFactory tokenFactory;
        bytes tokenFactoryData;
        IDopplerDeployer poolInitializer;
        bytes poolInitializerData;
    }

    /**
     * @notice Mine for a valid salt that produces hook address with required flags
     * @param params Mining parameters
     * @return salt The mined salt
     * @return hook The calculated hook address
     * @return asset The calculated asset address
     */
    function mineV4(MineV4Params memory params) internal returns (bytes32 salt, address hook, address asset) {
        (
            uint256 minimumProceeds,
            uint256 maximumProceeds,
            uint256 startingTime,
            uint256 endingTime,
            int24 startingTick,
            int24 endingTick,
            uint256 epochLength,
            int24 gamma,
            bool isToken0,
            uint256 numPDSlugs,
            uint24 lpFee, // int24 tickSpacing - unused in calculations

        ) = abi.decode(
                params.poolInitializerData,
                (uint256, uint256, uint256, uint256, int24, int24, uint256, int24, bool, uint256, uint24, int24)
            );

        // Load actual compiled bytecode files (same as TypeScript version)
        Vm vm = Vm(address(bytes20(uint160(uint256(keccak256("hevm cheat code"))))));

        bytes32 dopplerInitHash = keccak256(
            abi.encodePacked(
                HARDCODED_DOPPLER_BYTECODE,
                abi.encode(
                    params.poolManager,
                    params.numTokensToSell,
                    minimumProceeds,
                    maximumProceeds,
                    startingTime,
                    endingTime,
                    startingTick,
                    endingTick,
                    epochLength,
                    gamma,
                    isToken0,
                    numPDSlugs,
                    address(params.poolInitializer), // Use the UniswapV4Initializer address
                    lpFee
                )
            )
        );

        (
            string memory name,
            string memory symbol,
            uint256 yearlyMintCap,
            uint256 vestingDuration,
            address[] memory recipients,
            uint256[] memory amounts,
            string memory tokenURI
        ) = abi.decode(params.tokenFactoryData, (string, string, uint256, uint256, address[], uint256[], string));

        bytes32 tokenInitHash = keccak256(
            abi.encodePacked(
                HARDCODED_DERC20_BYTECODE,
                abi.encode(
                    name,
                    symbol,
                    params.initialSupply,
                    params.airlock,
                    params.airlock,
                    yearlyMintCap,
                    vestingDuration,
                    recipients,
                    amounts,
                    tokenURI
                )
            )
        );

        // Access the deployer field directly via low-level call
        // The deployer() function is a public immutable getter
        (bool success, bytes memory result) = address(params.poolInitializer).staticcall(
            abi.encodeWithSignature("deployer()")
        );
        require(success, "Failed to get deployer address");
        address deployer = abi.decode(result, (address));

        // Debug logging to trace address mismatch
        console.log("=== MINING DEBUG ===");
        console.log("Deployer address: %s", deployer);
        console.log("Pool initializer: %s", address(params.poolInitializer));
        console.log("Pool manager: %s", params.poolManager);
        console.log("Num tokens to sell: %s", params.numTokensToSell);
        console.log("Starting time: %s", startingTime);
        console.log("Ending time: %s", endingTime);
        console.log("Starting tick: %s", uint256(int256(startingTick)));
        console.log("Ending tick: %s", uint256(int256(endingTick)));
        console.log("Minimum proceeds: %s", minimumProceeds);
        console.log("Maximum proceeds: %s", maximumProceeds);

        for (uint256 saltCounter; saltCounter < 200_000; ++saltCounter) {
            bytes32 currentSalt = bytes32(saltCounter);
            address currentHook = computeCreate2Address(currentSalt, dopplerInitHash, deployer);
            address currentAsset = computeCreate2Address(currentSalt, tokenInitHash, address(params.tokenFactory));

            if (
                (uint160(currentHook) & FLAG_MASK) & FLAGS_DOPPLER_HOOK == FLAGS_DOPPLER_HOOK &&
                currentHook.code.length == 0 &&
                ((isToken0 && currentAsset < params.numeraire) || (!isToken0 && currentAsset > params.numeraire))
            ) {
                return (currentSalt, currentHook, currentAsset);
            }
        }

        revert("DopplerMiner: could not find salt");
    }

    /**
     * @notice Compute CREATE2 address using vm.computeCreate2Address for consistency
     * @param salt Salt for deployment
     * @param initCodeHash Hash of init code
     * @param deployer Deployer address
     * @return Computed address
     */
    function computeCreate2Address(bytes32 salt, bytes32 initCodeHash, address deployer) internal returns (address) {
        Vm vm = Vm(address(bytes20(uint160(uint256(keccak256("hevm cheat code"))))));
        return vm.computeCreate2Address(salt, initCodeHash, deployer);
    }
}
